# BIOM Bundle Format (v2.1)

This document describes the format and contents of BIOM bundles generated by the eDNA Explorer data pipeline.

## Bundle Location

Bundles are stored in Google Cloud Storage at:
```
gs://{bucket}/projects/{project_id}/assign/{qc_run_id}/{marker_id}/{marker}-biom.tar.zst
```

**Example:**
```
gs://edna-project-files-staging/projects/cm1s4f5da00013w0g01q7urrb/assign/cmioolhec0001jm04cey5xlkb/4ed7172a-1c30-4a70-8a81-83053ec114c3/16S_Bacteria-biom.tar.zst
```

## Decompression

The bundle is compressed with zstd level 19. To extract:

```bash
# Decompress and extract in one step
zstd -d 16S_Bacteria-biom.tar.zst -c | tar -xf -

# Or two steps
zstd -d 16S_Bacteria-biom.tar.zst
tar -xf 16S_Bacteria-biom.tar
```

## Bundle Contents

Each bundle contains files for up to three read modes: `paired`, `unpaired_f`, and `unpaired_r`.

| File | Description |
|------|-------------|
| `{marker}-{mode}-asv.biom` | ASV feature table (HDF5 BIOM format) |
| `{marker}-{mode}-taxa.biom` | Taxonomy-collapsed feature table (HDF5 BIOM format) |
| `{marker}-{mode}-lookup.tsv` | ASV lookup table with sequences and taxonomy |
| `{marker}-{mode}-assignments.tsv` | Full taxonomic assignments from Tronko |
| `{marker}-paired_f.fasta.zst` | Forward sequences (paired mode, zstd compressed) |
| `{marker}-paired_r.fasta.zst` | Reverse sequences (paired mode, zstd compressed) |
| `{marker}-unpaired_f.fasta.zst` | Unpaired forward sequences (zstd compressed) |
| `{marker}-unpaired_r.fasta.zst` | Unpaired reverse sequences (zstd compressed) |
| `samples.tsv` | Sample metadata (shared across all modes) |

---

## File Formats

### 1. ASV BIOM (`{marker}-{mode}-asv.biom`)

HDF5-based BIOM 2.1 format feature table containing raw ASV counts.

**Structure:**
- **Rows (Observations):** ASV feature IDs (e.g., `16S_Bacteria_paired_F_1063909`)
- **Columns (Samples):** Sample IDs (database CUIDs)
- **Values:** Read counts per ASV per sample
- **Metadata:** None (use sidecar files for metadata)

**ASV ID Format:** `{marker}_{mode}_{direction}_{seq_number}`
- Example: `16S_Bacteria_paired_F_819859`
- `seq_number` links to FASTA headers and lookup tables

**Typical dimensions:**
- Observations: 1,000,000+ ASVs
- Samples: varies by project

### 2. Taxa BIOM (`{marker}-{mode}-taxa.biom`)

HDF5-based BIOM 2.1 format feature table with counts collapsed by taxonomy.

**Structure:**
- **Rows (Observations):** Taxonomic paths (e.g., `Bacteria;Proteobacteria;Gammaproteobacteria;...`)
- **Columns (Samples):** Sample IDs
- **Values:** Summed read counts per taxon per sample
- **Observation Metadata:** Taxonomic quality metrics

**Observation Metadata Fields:**

| Field | Type | Description |
|-------|------|-------------|
| `taxonomy` | string | Full taxonomic path (semicolon-delimited) |
| `taxonomic_path` | string | Same as taxonomy (for compatibility) |
| `total_asvs` | int | Number of ASVs collapsed into this taxon |
| `mean_score` | float | Mean Tronko assignment score |
| `mean_forward_mismatch` | float | Mean forward primer mismatches |
| `mean_reverse_mismatch` | float | Mean reverse primer mismatches |
| `mean_chi2` | float | Mean chi-squared score (chimera indicator) |
| `mean_divergence` | float | Mean sequence divergence |
| `confidence_level` | int | Confidence tier (1-5, higher = more confident) |

### 3. Lookup TSV (`{marker}-{mode}-lookup.tsv`)

Tab-separated file for quick ASV filtering and sequence retrieval.

**Columns:**

| Column | Type | Description |
|--------|------|-------------|
| `feature_id` | string | ASV ID matching BIOM observation IDs |
| `read_set` | string | Read direction (`paired_F`, `paired_R`, `unpaired_F`, `unpaired_R`) |
| `sequence_md5` | string | MD5 hash of the sequence |
| `sequence_length` | int | Length of the sequence in base pairs |
| `taxonomy` | string | Assigned taxonomy (semicolon-delimited) |
| `confidence` | int | Confidence level (0-5) |

**Example:**
```tsv
feature_id	read_set	sequence_md5	sequence_length	taxonomy	confidence
16S_Bacteria_paired_F_819859	paired_F	7898fe9d09d75611a6c833caaa3c55b0	273	Bacteria;Acidobacteria;Acidobacteriia;Acidobacteriales;Acidobacteriaceae;NA	3
16S_Bacteria_paired_R_39553	paired_R	76c38d19755e53b06a2f044278569752	266	Unassigned	0
```

### 4. Assignments TSV (`{marker}-{mode}-assignments.tsv`)

Tab-separated file with full Tronko taxonomic assignment details.

**Columns:**

| Column | Type | Description |
|--------|------|-------------|
| `readname` | string | ASV ID (matches `feature_id` in lookup) |
| `taxonomic_path` | string | Full taxonomic assignment |
| `score` | float | Tronko assignment score (negative log-likelihood) |
| `forward_mismatch` | float | Forward primer mismatch count |
| `reverse_mismatch` | float | Reverse primer mismatch count |
| `tree_number` | int | Reference tree index |
| `node_number` | int | Node position in reference tree |
| `forward_length` | int | Forward read length |
| `reverse_length` | int | Reverse read length |
| `divergence` | float | Sequence divergence from reference |
| `chi2` | float | Chi-squared statistic (chimera detection) |

**Example:**
```tsv
readname	taxonomic_path	score	forward_mismatch	reverse_mismatch	tree_number	node_number	forward_length	reverse_length	divergence	chi2
16S_Bacteria_paired_F_909386	Bacteria;Actinobacteria;Actinobacteria;Micromonosporales;Micromonosporaceae;Actinoplanes	-126.746	3.0	3.0	11856	18	273	272	0.011	0.00002
```

### 5. Samples TSV (`samples.tsv`)

Tab-separated file with all sample metadata, shared across modes.

**Core Columns:**

| Column | Type | Description |
|--------|------|-------------|
| `sample_id` | string | User-provided sample name |
| `database_id` | string | Internal database CUID |
| `latitude` | float | Sample collection latitude |
| `longitude` | float | Sample collection longitude |
| `state` | string | State/province (if available) |
| `country` | string | Country (if available) |
| `sample_date` | datetime | Collection date (if available) |

**GEE Environmental Columns (350+):**

The samples.tsv includes Google Earth Engine environmental variables when available. Categories include:

- **Climate:** temperature, precipitation, aridity, vapor pressure
- **Vegetation:** NDVI, EVI, LAI, forest cover, land cover classes
- **Soil:** pH, organic carbon, texture, moisture, bulk density
- **Topography:** elevation, slope, aspect
- **Hydrology:** watershed info, runoff, water bodies
- **Human Impact:** urbanization, roads, mining, nightlights
- **Atmospheric:** aerosol index, O3, NO2, CO, CH4, SO2

See the file header for the complete list of available columns.

### 6. FASTA Files (`*.fasta.zst`)

Zstandard-compressed FASTA files containing ASV sequences.

**Header Format:**
```
>{marker}_{mode}_{direction}_{seq_number}
ACGTACGT...
```

**Example:**
```
>16S_Bacteria_paired_F_819859
TACGTAGGTGGCAAGCGTTATCCGGAATTATTGGGCGTAAAGCGCGCGTAGGCGG...
```

To decompress:
```bash
zstd -d 16S_Bacteria-paired_f.fasta.zst
```

---

## Usage Examples

### Load ASV BIOM in Python

```python
from biom import load_table

# Load the table
table = load_table('16S_Bacteria-paired-asv.biom')

# Get dimensions
print(f"ASVs: {table.shape[0]}, Samples: {table.shape[1]}")

# Get sample IDs
sample_ids = table.ids(axis='sample')

# Get counts for a specific sample
counts = table.data('sample_id_here', axis='sample', dense=True)

# Convert to pandas DataFrame
df = table.to_dataframe()
```

### Join Lookup with Assignments

```python
import pandas as pd

lookup = pd.read_csv('16S_Bacteria-paired-lookup.tsv', sep='\t')
assignments = pd.read_csv('16S_Bacteria-paired-assignments.tsv', sep='\t')

# Join on feature_id / readname
merged = lookup.merge(
    assignments,
    left_on='feature_id',
    right_on='readname',
    how='left'
)
```

### Filter High-Confidence Taxa

```python
import pandas as pd

lookup = pd.read_csv('16S_Bacteria-paired-lookup.tsv', sep='\t')

# Filter for confidence level >= 3
high_conf = lookup[lookup['confidence'] >= 3]
print(f"High confidence ASVs: {len(high_conf)}")
```

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 2.1 | 2026-01-21 | Zstd level 19 compression on entire tar; metadata moved to sidecar TSVs |
| 2.0 | 2026-01-20 | Parquet-only pipeline, no BigQuery dependency |
| 1.0 | 2025-xx-xx | Initial BIOM bundle format |
